name: "Render TikTok Video (auto t√≠tulo)"

on:
  workflow_dispatch:
    inputs:
      out_name:
        description: "Nombre del archivo de salida"
        required: true
        default: "futurocientifico.mp4"
      text1:
        description: "Texto 1 (branding)"
        required: false
        default: "FuturoCient√≠fico üöÄ Ciencia en 1 minuto"
      text2:
        description: "T√≠tulo (si lo dejas vac√≠o o con el default, se toma del √∫ltimo art√≠culo)"
        required: false
        default: "Un dato cient√≠fico al d√≠a"
      text3:
        description: "Texto 3 (CTA)"
        required: false
        default: "#Ciencia #Curiosidades #FuturoCient√≠fico"
      text4:
        description: "Texto 4 (URL / redes)"
        required: false
        default: "IG:@futurocientifico2025 ‚Ä¢ TikTok:@futurocientifico ‚Ä¢ X:@futuro100tico ‚Ä¢ YouTube:@futurocientifico"
      duration:
        description: "Duraci√≥n del v√≠deo (segundos)"
        required: true
        default: "59"

permissions:
  contents: write

env:
  TZ: Europe/Madrid
  IMAGE_PATH: public/avatar-cientifico.png
  # M√∫sica libre (CC0) de FreePD:
  DEFAULT_MUSIC_URL: "https://freepd.com/music/Adventure.mp3"

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar ffmpeg, jq y fuentes
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq fonts-dejavu-core

      - name: Verificar imagen fija
        run: |
          set -euo pipefail
          if [ ! -s "$IMAGE_PATH" ]; then
            echo "‚ùå No existe $IMAGE_PATH"
            ls -la public || true
            exit 1
          fi
          echo "‚úÖ Usando imagen: $IMAGE_PATH"

      - name: Obtener t√≠tulo del √∫ltimo art√≠culo (enriched o fallback)
        id: lasttitle
        run: |
          set -euo pipefail
          FILE=""
          if [ -s public/articles_enriched.json ]; then
            FILE=public/articles_enriched.json
          elif [ -s public/articles.json ]; then
            FILE=public/articles.json
          else
            echo "‚ùå No hay public/articles_enriched.json ni public/articles.json"
            exit 1
          fi
          echo "Leyendo de: $FILE"

          # Tomamos el √∫ltimo por fecha (published o date), priorizando title_es
          TITLE=$(jq -r 'sort_by(.published // .date) | reverse | .[0] | (.title_es // .title // "")' "$FILE")
          if [ -z "$TITLE" ] || [ "$TITLE" = "null" ]; then
            echo "‚ùå No se pudo extraer un t√≠tulo"
            exit 1
          fi

          # Guardamos en GITHUB_ENV para usarlo despu√©s
          echo "AUTO_TITLE=$TITLE" >> "$GITHUB_ENV"
          echo "T√≠tulo detectado: $TITLE"

      - name: Preparar audio (por defecto FreePD, o archivo local si existe)
        run: |
          set -euo pipefail
          DUR="${{ github.event.inputs.duration }}"

          if [ -s "public/audio/default.mp3" ]; then
            echo "üéµ Usando audio local public/audio/default.mp3"
            IN=public/audio/default.mp3
          else
            echo "üåê Descargando m√∫sica por defecto: $DEFAULT_MUSIC_URL"
            curl -L --fail -o default_music.mp3 "$DEFAULT_MUSIC_URL" || { echo "‚ö†Ô∏è Fall√≥ la descarga, genero silencio"; IN=""; }
            [ -f default_music.mp3 ] && IN=default_music.mp3 || IN=""
          fi

          if [ -z "$IN" ]; then
            echo "üîá Genero audio silencioso ${DUR}s"
            ffmpeg -y -f lavfi -t "$DUR" -i anullsrc=r=44100:cl=stereo -c:a aac -b:a 128k music_in.m4a
          else
            echo "üéöÔ∏è Normalizo a AAC est√©reo 44.1k"
            ffmpeg -y -i "$IN" -vn -ac 2 -ar 44100 -c:a aac -b:a 128k music_in.m4a
          fi

      - name: Crear archivos de texto (usa input o auto-t√≠tulo si aplica)
        run: |
          set -euo pipefail
          T1="${{ github.event.inputs.text1 }}"
          # Si text2 viene vac√≠o o con el default, usamos el auto-t√≠tulo detectado
          IN_T2="${{ github.event.inputs.text2 }}"
          if [ -z "$IN_T2" ] || [ "$IN_T2" = "Un dato cient√≠fico al d√≠a" ]; then
            T2="${AUTO_TITLE}"
          else
            T2="$IN_T2"
          fi
          T3="${{ github.event.inputs.text3 }}"
          T4="${{ github.event.inputs.text4 }}"

          printf "%s" "$T1" > t1.txt
          printf "%s" "$T2" > t2.txt
          printf "%s" "$T3" > t3.txt
          printf "%s" "$T4" > t4.txt

          echo "‚úîÔ∏è text2 usado: $T2"

      - name: Renderizar v√≠deo 1080x1920 con ffmpeg
        run: |
          set -euo pipefail
          OUT="${{ github.event.inputs.out_name }}"
          DUR="${{ github.event.inputs.duration }}"

          VF="scale=1080:-2,pad=1080:1920:(ow-iw)/2:(oh-ih)/2,format=yuv420p"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t1.txt:reload=1:fontsize=56:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=12:x=(w-text_w)/2:y=120"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t2.txt:reload=1:fontsize=64:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=12:x=(w-text_w)/2:y=360"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t3.txt:reload=1:fontsize=52:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=12:x=(w-text_w)/2:y=1520"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t4.txt:reload=1:fontsize=40:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=10:x=(w-text_w)/2:y=1700"

          ffmpeg -y -loop 1 -framerate 30 -i "$IMAGE_PATH" -i music_in.m4a \
            -t "$DUR" -filter:v "$VF" -c:v libx264 -pix_fmt yuv420p -profile:v high -preset veryfast -crf 20 \
            -c:a aac -b:a 128k -shortest "$OUT"

          echo "‚úÖ Render listo: $OUT"
          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tiktok-video
          path: ${{ github.workspace }}/${{ github.event.inputs.out_name }}
