name: Render TikTok (sin bandas, chip texto, cover XL)

on:
  workflow_dispatch:
    inputs:
      out_name:
        description: "Nombre del archivo de salida"
        required: true
        default: "futurocientifico.mp4"
      text1:
        description: "Texto 1 (branding)"
        required: false
        default: "FuturoCientífico · Ciencia en 1 minuto"
      text3:
        description: "Texto 3 (CTA)"
        required: false
        default: "#Ciencia #Curiosidades #FuturoCientífico"
      text4:
        description: "Redes (separadas por ' · ')"
        required: false
        default: "IG:@futurocientifico2025 · TikTok:@futurocientifico · X:@futuro100tico · YouTube:@futurocientifico"
      duration:
        description: "Duración del vídeo (segundos)"
        required: true
        default: "59"
      title_style:
        description: "Plantilla del título: strip | card | glow"
        required: false
        default: "strip"

permissions:
  contents: write

env:
  TZ: Europe/Madrid
  IMAGE_PATH: public/avatar-cientifico.png
  DEFAULT_MUSIC_URL: "https://freepd.com/music/Adventure.mp3"
  PROMPT_TEMPLATE_FILE: scripts/prompt-template.txt

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: 🧰 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🛠️ Instalar ffmpeg, jq e ImageMagick (fuentes)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq imagemagick fonts-dejavu-core

      - name: 📂 Preparar carpeta por fecha
        run: |
          set -euo pipefail
          TODAY="$(date +%F)"
          OUTDIR="media/${TODAY}"
          mkdir -p "${OUTDIR}"
          echo "TODAY=${TODAY}" >> "$GITHUB_ENV"
          echo "OUTDIR=${OUTDIR}" >> "$GITHUB_ENV"

      - name: ✅ Verificar enriched e imagen
        run: |
          set -euo pipefail
          test -s public/articles_enriched.json || { echo "Falta public/articles_enriched.json"; exit 1; }
          test -s "$IMAGE_PATH" || { echo "Falta $IMAGE_PATH"; exit 1; }

      - name: 📰 Elegir último artículo y preparar textos (wrap + tamaños + redes 2 líneas + chip)
        id: pick
        run: |
          set -euo pipefail
          FILE="public/articles_enriched.json"
          SEL="$(jq -c 'sort_by(.