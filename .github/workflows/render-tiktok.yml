name: "Render TikTok Video"

on:
  workflow_dispatch:
    inputs:
      out_name:
        description: "Nombre del archivo de salida"
        required: true
        default: "futurocientifico.mp4"
      text1:
        description: "Texto 1 (branding)"
        required: true
        default: "FuturoCientífico 🚀 Ciencia en 1 minuto"
      text2:
        description: "Texto 2 (principal)"
        required: true
        default: "Un dato científico al día"
      text3:
        description: "Texto 3 (CTA)"
        required: false
        default: "Síguenos @futurocientifico"
      text4:
        description: "Texto 4 (URL)"
        required: false
        default: "futurocientifico.vercel.app"
      duration:
        description: "Duración del vídeo (segundos)"
        required: true
        default: "59"

permissions:
  contents: write

env:
  TZ: Europe/Madrid
  IMAGE_PATH: public/avatar-cientifico.png
  # Música por defecto (CC0 – FreePD). Puedes cambiarla por otra URL directa a MP3.
  DEFAULT_MUSIC_URL: "https://freepd.com/music/Adventure.mp3"

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar ffmpeg y fuentes
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-dejavu-core

      - name: Verificar imagen fija
        run: |
          set -euo pipefail
          if [ ! -s "$IMAGE_PATH" ]; then
            echo "❌ No existe $IMAGE_PATH"
            echo "Contenido de public/:"
            ls -la public || true
            exit 1
          fi
          echo "✅ Usando imagen: $IMAGE_PATH"

      - name: Preparar audio (por defecto FreePD, o archivo local si existe)
        run: |
          set -euo pipefail
          DUR="${{ github.event.inputs.duration }}"

          # Si existe un audio local en el repo, se usa preferentemente
          if [ -s "public/audio/default.mp3" ]; then
            echo "🎵 Usando audio local public/audio/default.mp3"
            IN=public/audio/default.mp3
          else
            echo "🌐 Descargando música por defecto: $DEFAULT_MUSIC_URL"
            curl -L --fail -o default_music.mp3 "$DEFAULT_MUSIC_URL" || { echo "⚠️ Falló la descarga, genero silencio"; IN=""; }
            [ -f default_music.mp3 ] && IN=default_music.mp3 || IN=""
          fi

          if [ -z "$IN" ]; then
            echo "🔇 Genero audio silencioso ${DUR}s"
            ffmpeg -y -f lavfi -t "$DUR" -i anullsrc=r=44100:cl=stereo -c:a aac -b:a 128k music_in.m4a
          else
            echo "🎚️ Normalizo a AAC estéreo 44.1k"
            ffmpeg -y -i "$IN" -vn -ac 2 -ar 44100 -c:a aac -b:a 128k music_in.m4a
          fi

      - name: Crear archivos de texto (evita problemas de escapado)
        run: |
          set -euo pipefail
          printf "%s" "${{ github.event.inputs.text1 }}" > t1.txt
          printf "%s" "${{ github.event.inputs.text2 }}" > t2.txt
          printf "%s" "${{ github.event.inputs.text3 }}" > t3.txt
          printf "%s" "${{ github.event.inputs.text4 }}" > t4.txt

      - name: Renderizar vídeo 1080x1920 con ffmpeg
        run: |
          set -euo pipefail
          OUT="${{ github.event.inputs.out_name }}"
          DUR="${{ github.event.inputs.duration }}"

          VF="scale=1080:-2,pad=1080:1920:(ow-iw)/2:(oh-ih)/2,format=yuv420p"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t1.txt:reload=1:fontsize=56:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=12:x=(w-text_w)/2:y=120"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t2.txt:reload=1:fontsize=64:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=12:x=(w-text_w)/2:y=360"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t3.txt:reload=1:fontsize=52:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=12:x=(w-text_w)/2:y=1520"
          VF="$VF,drawtext=font='DejaVu Sans':textfile=t4.txt:reload=1:fontsize=40:fontcolor=white:box=1:boxcolor=0x00000088:boxborderw=10:x=(w-text_w)/2:y=1700"

          ffmpeg -y -loop 1 -framerate 30 -i "$IMAGE_PATH" -i music_in.m4a \
            -t "$DUR" -filter:v "$VF" -c:v libx264 -pix_fmt yuv420p -profile:v high -preset veryfast -crf 20 \
            -c:a aac -b:a 128k -shortest "$OUT"

          echo "✅ Render listo: $OUT"
          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: video
          path: ${{ github.workspace }}/${{ github.event.inputs.out_name }}
