---
import Layout from '../../layouts/Layout.astro';
import Seo from '../../components/Seo.astro';

import fs from "node:fs/promises";
import path from "node:path";

const PER_PAGE = 10;
const JSON_PATH = path.join(process.cwd(), "public", "eduflash.json");

let allArticles = [];
try {
  const raw = await fs.readFile(JSON_PATH, "utf-8");
  const parsed = JSON.parse(raw);
  allArticles = Array.isArray(parsed) ? parsed : [];
} catch {
  allArticles = [];
}

allArticles.sort((a, b) => new Date(b?.date || 0) - new Date(a?.date || 0));
const initialArticles = allArticles.slice(0, PER_PAGE);
---

<Seo 
  title="EduFlash | Noticias Educativas Oficiales"
  description="Noticias educativas actualizadas autom√°ticamente desde fuentes oficiales y sindicales de Espa√±a, como Andaluc√≠a, Galicia, Madrid y m√°s."
  site="https://futurocientifico.vercel.app/eduflash"
/>

<Layout>
  <section class="mb-6 p-4 bg-yellow-50 rounded-xl text-sm text-yellow-800 text-center">
    <h1 class="text-3xl font-bold text-yellow-900 mb-2">‚ö° EduFlash</h1>
    <p>
      Noticias educativas seleccionadas de forma autom√°tica desde fuentes oficiales como la <strong>Junta de Andaluc√≠a</strong>, 
      <strong>Xunta de Galicia</strong>, <strong>Comunidad de Madrid</strong> y portales sindicales educativos.
    </p>
    <p class="mt-2 text-yellow-700 text-base">
      Una recopilaci√≥n diaria con las novedades educativas m√°s relevantes, para estudiantes, docentes y familias. Informaci√≥n clara y actualizada directamente desde los portales auton√≥micos y sindicatos.
    </p>
  </section>

  <section class="bg-white py-6 px-4 max-w-6xl mx-auto rounded-xl shadow-sm mb-8">
    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
      <h2 class="text-2xl font-bold text-yellow-900">üì∞ √öltimas noticias educativas</h2>
      <p class="text-yellow-800 mb-6">
        Esta secci√≥n se actualiza autom√°ticamente todos los d√≠as. Incluye titulares y res√∫menes breves de las noticias m√°s recientes.
      </p>
    </div>

    <!-- Render inicial (SSG/SSR) -->
    <div id="eduflash" class="w-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {initialArticles.map((article) => {
        const hasContent = article?.content_es && article.content_es.trim() !== "";
        const title = article?.title_es ?? article?.title ?? "Noticia educativa";
        const source = article?.source ?? "Fuente";
        const href = article?.url ?? "#";
        const date = article?.date ? new Date(article.date).toLocaleDateString() : "";

        return (
          <article class="bg-white rounded-xl p-4 shadow-md">
            <h3 class="text-xl font-semibold text-yellow-900">{title}</h3>
            <p class="text-gray-600 text-sm mb-2">{source}{date ? ` | ${date}` : ""}</p>
            {hasContent ? <p class="text-gray-800">{article.content_es}</p> : null}
            <a
              href={href}
              target="_blank"
              rel="noopener noreferrer"
              class="text-yellow-700 hover:underline block mt-2"
            >
              Leer m√°s
            </a>
          </article>
        );
      })}
    </div>

    <div class="flex justify-center mt-8">
      <button id="loadMore" class="bg-yellow-700 text-white px-4 py-2 rounded hover:bg-yellow-800 hidden">
        Ver m√°s noticias
      </button>
    </div>
  </section>

  <script type="module">
    const container = document.querySelector('#eduflash');
    const button = document.querySelector('#loadMore');

    const perPage = 10;
    let currentPage = 2; // üëà ya hay 1¬™ p√°gina renderizada en HTML
    let allArticles = [];

    fetch('/eduflash.json')
      .then(res => res.json())
      .then(data => {
        allArticles = (Array.isArray(data) ? data : [])
          .sort((a, b) => new Date(b?.date || 0) - new Date(a?.date || 0));

        if (allArticles.length > perPage) button.classList.remove('hidden');
      });

    function renderPage() {
      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const currentArticles = allArticles.slice(start, end);

      currentArticles.forEach(article => {
        const hasContent = article.content_es && article.content_es.trim() !== "";
        const title = article.title_es || article.title || "Noticia educativa";
        const date = article.date ? new Date(article.date).toLocaleDateString() : "";
        const html = `
          <article class="bg-white rounded-xl p-4 shadow-md">
            <h3 class="text-xl font-semibold text-yellow-900">${title}</h3>
            <p class="text-gray-600 text-sm mb-2">${article.source || 'Fuente'}${date ? ` | ${date}` : ''}</p>
            ${hasContent ? `<p class="text-gray-800">${article.content_es}</p>` : ''}
            <a href="${article.url || '#'}" target="_blank" rel="noopener noreferrer" class="text-yellow-700 hover:underline block mt-2">Leer m√°s</a>
          </article>`;
        container.insertAdjacentHTML('beforeend', html);
      });

      currentPage++;

      if ((currentPage - 1) * perPage >= allArticles.length) {
        button.classList.add('hidden');
      }
    }

    button.addEventListener('click', renderPage);
  </script>

  <section class="bg-yellow-100 mt-12 py-6 rounded-xl shadow-sm">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-xl font-bold text-yellow-800 mb-4">¬øTe interesa la actualidad educativa?</h2>
      <p class="text-yellow-700 mb-4">Explora EduFlash cada semana y mantente informado sobre novedades, convocatorias y cambios normativos en educaci√≥n.</p>
      <a href="/formacion" class="bg-yellow-700 hover:bg-yellow-800 text-white py-2 px-4 rounded-xl shadow">Explorar formaci√≥n educativa</a>
    </div>
  </section>

  <!-- CTA final -->
  <section class="bg-purple-100 mt-12 py-6 rounded-xl shadow-sm">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-xl font-bold text-purple-800 mb-4">¬øQuieres aprender a leer ciencia?</h2>
      <p class="text-purple-700 mb-4">Explora nuestras secciones de formaci√≥n, recursos y ciencia ciudadana para descubrir m√°s herramientas y contenidos.</p>
      <div class="flex justify-center gap-4 flex-wrap">
        <a href="/formacion" class="bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded-xl shadow">Formaci√≥n</a>
        <a href="/recursos" class="bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded-xl shadow">Recursos</a>
        <a href="/preguntona" class="bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded-xl shadow">Preguntona</a>
      </div>
    </div>
  </section>

  <!-- Adsense -->
  <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2163450732409344"
     data-ad-slot="6134548917"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  <script>
    if (typeof window !== "undefined") {
      if (window.adsbygoogle && Array.isArray(window.adsbygoogle)) {
        window.adsbygoogle.push({});
      } else {
        const interval = setInterval(() => {
          if (window.adsbygoogle && Array.isArray(window.adsbygoogle)) {
            window.adsbygoogle.push({});
            clearInterval(interval);
          }
        }, 300);
      }
    }
  </script>
</Layout>
